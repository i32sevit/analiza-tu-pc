<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>AnalizaTuPC</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f3f6fa;
      margin: 0;
      padding: 20px;
    }

    h1 {
      color: #003366;
    }

    .container {
      max-width: 900px;
      margin: auto;
      padding: 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }

    input, select {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    button {
      padding: 10px 20px;
      margin-top: 15px;
      font-size: 16px;
      background: #003366;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    button:hover {
      background: #004b99;
    }

    #out {
      white-space: pre-wrap;
      background: #eef3ff;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      font-size: 15px;
    }

    /* MODAL */
    #authModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }

    #authModal .modal-content {
      background: white;
      padding: 20px;
      width: 400px;
      border-radius: 10px;
      text-align: center;
    }

    #closeAuthModal {
      background: red !important;
    }

    .user-box {
      padding: 10px;
      margin-bottom: 10px;
      background: #dde9ff;
      border-radius: 6px;
    }
  </style>

  <script>
    const { ipcRenderer } = require("electron");
  </script>

</head>

<body>

<div class="container">

  <h1> Analizar PC</h1>

  <div id="userBox" class="user-box" style="display:none;">
      Usuario: <span id="loggedUsername"></span>
      <button id="logoutBtn" style="background:red; float:right;">Salir</button>
  </div>

  <div id="authButtons">
      <button id="openLoginModalBtn">Iniciar Sesi贸n</button>
      <button id="openRegisterModalBtn">Registrarse</button>
      <button id="guestBtn">Entrar como Invitado</button>
  </div>

  <hr>

  <label>CPU Modelo:</label>
  <input id="cpu_model" type="text">

  <label>Velocidad CPU (GHz):</label>
  <input id="cpu_speed_ghz" type="number">

  <label>N煤mero de n煤cleos:</label>
  <input id="cores" type="number">

  <label>RAM (GB):</label>
  <input id="ram_gb" type="number">

  <label>Tipo de Disco:</label>
  <select id="disk_type">
      <option value="SSD">SSD</option>
      <option value="HDD">HDD</option>
  </select>

  <label>GPU Modelo:</label>
  <input id="gpu_model" type="text">

  <label>VRAM (GB):</label>
  <input id="gpu_vram_gb" type="number">

  <button id="btn">Analizar</button>

  <pre id="out"></pre>

</div>

<!--  Auth Modal -->
<div id="authModal">
  <div class="modal-content">

    <h2 id="modalTitle">Iniciar Sesi贸n</h2>

    <input id="modalUsername" type="text" placeholder="Usuario">
    <input id="modalEmail" type="email" placeholder="Email (solo registro)">
    <input id="modalPassword" type="password" placeholder="Contrase帽a">

    <div style="margin-top: 10px;">
      <button id="modalActionBtn">Aceptar</button>
      <button id="closeAuthModal">Cerrar</button>
    </div>

  </div>
</div>

<script src="renderer.js"></script>

<script>
/* ---------------------------------------------
   MANEJO DE LOGIN/REGISTRO EN EL INDEX
---------------------------------------------- */

const authModal = document.getElementById("authModal");
const modalTitle = document.getElementById("modalTitle");
const modalUsername = document.getElementById("modalUsername");
const modalEmail = document.getElementById("modalEmail");
const modalPassword = document.getElementById("modalPassword");
const modalActionBtn = document.getElementById("modalActionBtn");

const userBox = document.getElementById("userBox");
const loggedUsername = document.getElementById("loggedUsername");

let currentAuthMode = "login"; // login | register


// -------------------------
// ABRIR LOGIN
// -------------------------
document.getElementById("openLoginModalBtn").onclick = () => {
    currentAuthMode = "login";
    modalTitle.innerText = "Iniciar Sesi贸n";
    modalEmail.style.display = "none";
    modalUsername.value = "";
    modalPassword.value = "";
    authModal.style.display = "flex";
};

// -------------------------
// ABRIR REGISTRO
// -------------------------
document.getElementById("openRegisterModalBtn").onclick = () => {
    currentAuthMode = "register";
    modalTitle.innerText = "Registrarse";
    modalEmail.style.display = "block";
    modalUsername.value = "";
    modalEmail.value = "";
    modalPassword.value = "";
    authModal.style.display = "flex";
};

// -------------------------
// CERRAR MODAL
// -------------------------
document.getElementById("closeAuthModal").onclick = () => {
    authModal.style.display = "none";
};


// -------------------------
// ENTRAR COMO INVITADO
// -------------------------
document.getElementById("guestBtn").onclick = () => {
    localStorage.setItem("is_guest", "true");
    localStorage.removeItem("auth_token");
    localStorage.removeItem("user");

    userBox.style.display = "block";
    loggedUsername.innerText = "Invitado";
    authButtons.style.display = "none";
};


// -------------------------
// ACCIN LOGIN/REGISTRO
// -------------------------
modalActionBtn.onclick = async () => {

    if (currentAuthMode === "login") {
        const username = modalUsername.value.trim();
        const password = modalPassword.value;

        const res = await fetch("http://localhost:8000/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password })
        });

        const data = await res.json();
        if (!res.ok) {
            alert(data.detail);
            return;
        }

        // Guardar y avisar al proceso principal
        localStorage.setItem("auth_token", data.access_token);
        localStorage.setItem("user", JSON.stringify(data.user));
        localStorage.removeItem("is_guest");

        ipcRenderer.invoke("auth-success", {
            token: data.access_token,
            user: data.user
        });

        loggedUsername.innerText = username;
        userBox.style.display = "block";
        authButtons.style.display = "none";

        authModal.style.display = "none";
    }

    if (currentAuthMode === "register") {
        const username = modalUsername.value.trim();
        const email = modalEmail.value.trim();
        const password = modalPassword.value;

        const res = await fetch("http://localhost:8000/register", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, email, password })
        });

        const data = await res.json();

        if (!res.ok) {
            alert(data.detail);
            return;
        }

        alert("Usuario creado correctamente. Ahora inicia sesi贸n.");
        authModal.style.display = "none";
    }
};


// -------------------------
// LOGOUT
// -------------------------
document.getElementById("logoutBtn").onclick = () => {
    localStorage.removeItem("auth_token");
    localStorage.removeItem("user");
    localStorage.removeItem("is_guest");

    ipcRenderer.invoke("logout");

    authButtons.style.display = "block";
    userBox.style.display = "none";
    loggedUsername.innerText = "";
};


// -------------------------
// MOSTRAR ESTADO AL ENTRAR
// -------------------------
const savedUser = localStorage.getItem("user");
const isGuest = localStorage.getItem("is_guest");

if (savedUser) {
    const u = JSON.parse(savedUser);
    loggedUsername.innerText = u.username || u.email;
    userBox.style.display = "block";
    authButtons.style.display = "none";
}

if (isGuest === "true") {
    loggedUsername.innerText = "Invitado";
    userBox.style.display = "block";
    authButtons.style.display = "none";
}

</script>

</body>
</html>
